workspaces:
- name: Ground Control
  slug: groundcontrol
  description: A workspace containing all the master branches of Ground Control.
  notes: |
    ## Installation Notes

    You need:

    - Go >= v1.11
    - Node
    - Yarn

    To launch the app, run these tasks in order:

    * Install UI Dependencies
    * Generate Go Code
    * Launch

    The Ground Control UI will be available on [http://localhost:3335](http://localhost:3335).

    To release, you need `goreleaser`. On macOS:

    ```
    brew install goreleaser/tap/goreleaser
    ```

    ### Notes
        
    #### General
        
    - Lines of code don't matter if the code can be generated. Focus on writing repeatable code then write a generator once it makes sense.
        
    #### Server
        
    - GraphQL models should be *pure*. Mutations should create a new copy of the model. Avoid pointer accessors for models.
    - Reference GraphQL models by ID. Do not keep pointers. Do not pass models around.
    - Models should only store GraphQL fields and IDs of nodes they reference. They must not store a mutex. Use `NodeManager.Lock()`.
    - Queries must have no side effects (except appending the log). This may require more mutations triggered by the client.
        
    #### Client
        
    - Queries, mutations, subscriptions, and events must be handled at the top level.
    - Avoid using `@relay(mask: false)`.
  projects:
  - slug: groundcontrol
    repository: git@github.com:stratumn/groundcontrol.git
    branch: master
    description: The main Ground Control application.
  - slug: groundcontrol-ui
    repository: git@github.com:stratumn/groundcontrol-ui.git
    branch: master
    description: The UI for Ground Control.
  - slug: groundcontrol-source
    repository: git@github.com:stratumn/groundcontrol-source.git
    branch: master
    description: The Ground Control source for Ground Control development.
  tasks:
  - name: Install UI Dependencies
    steps:
    - projects:
      - groundcontrol-ui
      commands:
      - yarn install
  - name: Generate Go Code
    steps:
    - projects:
      - groundcontrol
      commands:
      - go generate ./...
      - gofmt -w $(find . -name 'auto_*.go')
  - name: Launch
    steps:
    - projects:
      - groundcontrol
      commands:
      - spawn go run . --listen-address=:3334
    - projects:
      - groundcontrol-ui
      commands:
      - spawn PORT=3335 REACT_APP_GROUNDCONTROL_PORT=3334 yarn dev
  - name: Release
    variables:
    - name: GROUNDCONTROL_RELEASE_VERSION
    - default: vX.X.X
    steps:
    - projects:
      - groundcontrol
      - groundcontrol-ui
      commands:
      - git tag $GROUNDCONTROL_RELEASE_VERSION
      - git push origin $GROUNDCONTROL_RELEASE_VERSION
    - projects:
      - groundcontrol
      commands:
      - goreleaser
